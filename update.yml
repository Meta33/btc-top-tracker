name: Update BTC Top Tracker

on:
  schedule:
    # Runs every 6 hours (adjustable: */6 = every 6 hours, */1 = hourly, 0 */12 = twice daily)
    - cron: '0 */6 * * *'
  
  workflow_dispatch:  # Allows manual trigger from GitHub UI
  
  push:
    branches: [ main ]  # Triggers on push to main (for testing)

jobs:
  update-tracker:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Needed to commit changes
      issues: write    # Needed to create alert issues
    
    steps:
         - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Clear Python cache
      run: |
        rm -rf __pycache__
        rm -rf scripts/__pycache__
        find . -type d -name __pycache__ -exec rm -rf {} +
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ” Fetch Latest Market Data
        env:
          GLASSNODE_API_KEY: ${{ secrets.GLASSNODE_API_KEY }}
          COINMARKETCAP_API_KEY: ${{ secrets.COINMARKETCAP_API_KEY }}
        run: |
          python scripts/fetch_data.py
          echo "âœ… Market data fetched successfully"
      
      - name: ðŸ§® Calculate Composite Score
        run: |
          python scripts/calculate_score.py
          echo "âœ… Composite score calculated"
      
      - name: ðŸ“ Update README Dashboard
        run: |
          python scripts/update_readme.py
          echo "âœ… README updated"
      
      - name: ðŸš¨ Check for RED ALERT
        id: alert_check
        run: |
          SCORE=$(python -c "import json; print(json.load(open('data/current_signals.json'))['composite_score'])")
          echo "Current score: $SCORE%"
          
          if (( $(echo "$SCORE >= 70" | bc -l) )); then
            echo "alert=true" >> $GITHUB_OUTPUT
            echo "score=$SCORE" >> $GITHUB_OUTPUT
          else
            echo "alert=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ”” Create GitHub Issue Alert (if RED ALERT)
        if: steps.alert_check.outputs.alert == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.alert_check.outputs.score }}';
            const timestamp = new Date().toISOString();
            
            // Check if RED ALERT issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'red-alert'
            });
            
            if (issues.data.length === 0) {
              // Create new RED ALERT issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ RED ALERT: Bitcoin Cycle Top Confirmed (Score: ${score}%)`,
                body: `## ðŸš¨ RED ALERT TRIGGERED
                
**Composite Score:** ${score}%  
**Alert Level:** ðŸ”´ RED ALERT  
**Timestamp:** ${timestamp}

---

## âš ï¸ IMMEDIATE ACTION REQUIRED

The composite score has reached **${score}%**, crossing the 70% RED ALERT threshold.

Based on the tracking methodology, this indicates a **high probability that October 6, 2025 was the Bitcoin cycle top**.

### ðŸ“‹ Recommended Actions (Within 24 hours):

- [ ] Exit 50-75% of BTC position
- [ ] Move funds to USDC/USDT stablecoins
- [ ] Cancel all DCA buy orders
- [ ] Take screenshot of portfolio for records

### ðŸ“Š Current Signal Status

View the live dashboard: [README.md](../README.md)

### ðŸ”„ Next Steps

1. **Monitor for 7 days:** If score stays > 70% for a full week, exit remaining 25-50%
2. **Watch for reversals:** If score drops below 70%, reassess
3. **Set buy alerts:** Prepare for next cycle ($60K, $50K, $40K levels)

---

**This is an automated alert generated by GitHub Actions.**  
**Not financial advice - always do your own research.**

For more information, see the [Quick Start Guide](./docs/QUICK_START.md).`,
                labels: ['red-alert', 'automated']
              });
              
              console.log('âœ… RED ALERT issue created');
            } else {
              // Update existing issue
              const issue_number = issues.data[0].number;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: `**Update:** Score is now **${score}%** (${timestamp})`
              });
              
              console.log('âœ… RED ALERT issue updated');
            }
      
      - name: ðŸ’¾ Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add data/ README.md
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-update: $(date +'%Y-%m-%d %H:%M UTC')"
            git push
            echo "âœ… Changes committed and pushed"
          fi
      
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ“Š Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          python << PYEOF >> $GITHUB_STEP_SUMMARY
import json
with open('data/current_signals.json', 'r') as f:
    data = json.load(f)
    
print(f"**Composite Score:** {data['composite_score']:.1f}%")
print(f"**Alert Level:** {data['alert_level']}")
print("")
print("### Signal Status:")
for signal in data['signals']:
    status_emoji = "âœ…" if signal['triggered'] else "âŒ"
    print(f"- {status_emoji} {signal['name']}: {signal['current_value']}")
PYEOF
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tracker updated successfully!" >> $GITHUB_STEP_SUMMARY

